<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>title</title>
    <link rel="stylesheet" href="static/nv.d3.css" type="text/css">
    <script src="static/jquery-2.1.1.min.js"></script>
    <script src="static/d3.min.js"></script>
    <script src="static/nv.d3.min.js"></script>
  </head>
  <body>
    <div id="callsChart">
      <svg style='height:600px'/>
    </div>
    <div id="versionCallsChart">
      <svg style='height:600px'/>
    </div>

    <script type="text/javascript">
// plotting function.
function plotCalls(data, d3select) {
  var format = d3.time.format("%Y-%m-%d");
  nv.addGraph(function() {
    var chart = nv.models.stackedAreaChart()
                  .x(function(d) { return format.parse(d[0]) })
                  .y(function(d) { return d[1] })
                  .clipEdge(true)
                  .useInteractiveGuideline(true)
                  ;

    chart.xAxis
       .showMaxMin(false)
         .tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

    chart.yAxis
        .tickFormat(d3.format(',.d'));

    d3.select(d3select)
      .datum(data)
        .transition().duration(500).call(chart);

    nv.utils.windowResize(chart.update);

    return chart;
  });

}

function parseCalls(json){
    var days = json.days;
    var count = [];
    for(var i =0; i < days.length; i ++) {
      count.push(
          [days[i].date, days[i].calls]
      );
    }

    var data = [
        {
            key: "Calls",
            values: count
        }
    ];
    return data;
}


// Here's a more flexible version, which allows you to create 
// reusable sort functions, and sort by any field
// http://stackoverflow.com/a/979325/1940070
var sort_by = function(field, reverse, primer){

   var key = primer ? 
       function(x) {return primer(x[field])} : 
       function(x) {return x[field]};

   reverse = [-1, 1][+!!reverse];

   return function (a, b) {
       return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
     } 

}

function parseVersionCalls(json){
  // initialize the data object
  data = [];

  // loop through to get the versions
  var days = json.days;
  var versionNumbers = [];
  var emptyData = [];
  for(var i = 0; i < days.length; i++) {
    var dversions = days[i].versions;
    for(var j = 0; j < dversions.length; j++) {
      var index = $.inArray(dversions[j].number, versionNumbers)
      if (index < 0) {
        versionNumbers.push(dversions[j].number);
        var newData = {key: dversions[j].number, values: emptyData.slice(0)}
        data.push(newData);
        // set index to the array length -1, now that we have appended.
        index = versionNumbers.length -1;
      }
      data[index].values.push([days[i].date, dversions[j].calls]);
    }
    // append to the empty data.
    emptyData.push([days[i].date, 0]);
  }
  // sort the data by version number

  // sort version number, highest to lowest.
  data.sort(sort_by('key', false, function(a){return a.toUpperCase()}));

  return data;
}

$.getJSON("data/usage_2014-04-11_2014-05-11.json", function(data) {
  var totalCalls = parseCalls(data);
  plotCalls(totalCalls, '#callsChart svg');
  var versionCalls = parseVersionCalls(data);
  plotCalls(versionCalls, '#versionCallsChart svg');
});
    </script>
  </body>
</html>
